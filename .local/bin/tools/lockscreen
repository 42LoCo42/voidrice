#!/bin/bash
IMAGE=/tmp/lockscreen.png
TEXT=/tmp/locktext.png
ICON=.local/bin/tools/lockimage.png


if [ -z "$1" ]; then
	discord-status "idle" &
	mpc pause
	pauseallmpv
	xinput set-int-prop 10 "Device Enabled" 8 0
	xset dpms 0 0 5

	maim "$IMAGE"
	convert $IMAGE -scale 10% -scale 1000% -fill black -colorize 40% $IMAGE
	[ -f $TEXT ] || {
	    convert -size 1920x60 xc:white -font Linux-Biolinum -pointsize 50 -fill black -gravity center -annotate +0+0 'Type password to unlock' $TEXT;
	    convert $TEXT -alpha set -channel A -evaluate set 50% $TEXT;
	}
	convert $IMAGE $TEXT -gravity center -geometry +0+300 -composite $IMAGE
	convert $IMAGE $ICON -gravity center -composite -matte $IMAGE
	i3lock -u -i $IMAGE -n
	
	rm $IMAGE $TEXT
	xset dpms 0 0 0
	xinput set-int-prop 10 "Device Enabled" 8 1
	discord-status "online" &

else
	if [ -f "/tmp/dcidle" ]; then
		rm "/tmp/dcidle"
		discord-status "online"
	else
		touch "/tmp/dcidle"
		discord-status "idle"
	fi
fi

